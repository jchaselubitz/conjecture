revoke delete on table "public"."annotation" from "anon";

revoke insert on table "public"."annotation" from "anon";

revoke references on table "public"."annotation" from "anon";

revoke select on table "public"."annotation" from "anon";

revoke trigger on table "public"."annotation" from "anon";

revoke truncate on table "public"."annotation" from "anon";

revoke update on table "public"."annotation" from "anon";

revoke delete on table "public"."annotation" from "authenticated";

revoke insert on table "public"."annotation" from "authenticated";

revoke references on table "public"."annotation" from "authenticated";

revoke select on table "public"."annotation" from "authenticated";

revoke trigger on table "public"."annotation" from "authenticated";

revoke truncate on table "public"."annotation" from "authenticated";

revoke update on table "public"."annotation" from "authenticated";

revoke delete on table "public"."annotation" from "service_role";

revoke insert on table "public"."annotation" from "service_role";

revoke references on table "public"."annotation" from "service_role";

revoke select on table "public"."annotation" from "service_role";

revoke trigger on table "public"."annotation" from "service_role";

revoke truncate on table "public"."annotation" from "service_role";

revoke update on table "public"."annotation" from "service_role";

revoke delete on table "public"."collaborator" from "anon";

revoke insert on table "public"."collaborator" from "anon";

revoke references on table "public"."collaborator" from "anon";

revoke select on table "public"."collaborator" from "anon";

revoke trigger on table "public"."collaborator" from "anon";

revoke truncate on table "public"."collaborator" from "anon";

revoke update on table "public"."collaborator" from "anon";

revoke delete on table "public"."collaborator" from "authenticated";

revoke insert on table "public"."collaborator" from "authenticated";

revoke references on table "public"."collaborator" from "authenticated";

revoke select on table "public"."collaborator" from "authenticated";

revoke trigger on table "public"."collaborator" from "authenticated";

revoke truncate on table "public"."collaborator" from "authenticated";

revoke update on table "public"."collaborator" from "authenticated";

revoke delete on table "public"."collaborator" from "service_role";

revoke insert on table "public"."collaborator" from "service_role";

revoke references on table "public"."collaborator" from "service_role";

revoke select on table "public"."collaborator" from "service_role";

revoke trigger on table "public"."collaborator" from "service_role";

revoke truncate on table "public"."collaborator" from "service_role";

revoke update on table "public"."collaborator" from "service_role";

revoke delete on table "public"."comment" from "anon";

revoke insert on table "public"."comment" from "anon";

revoke references on table "public"."comment" from "anon";

revoke select on table "public"."comment" from "anon";

revoke trigger on table "public"."comment" from "anon";

revoke truncate on table "public"."comment" from "anon";

revoke update on table "public"."comment" from "anon";

revoke delete on table "public"."comment" from "authenticated";

revoke insert on table "public"."comment" from "authenticated";

revoke references on table "public"."comment" from "authenticated";

revoke select on table "public"."comment" from "authenticated";

revoke trigger on table "public"."comment" from "authenticated";

revoke truncate on table "public"."comment" from "authenticated";

revoke update on table "public"."comment" from "authenticated";

revoke delete on table "public"."comment" from "service_role";

revoke insert on table "public"."comment" from "service_role";

revoke references on table "public"."comment" from "service_role";

revoke select on table "public"."comment" from "service_role";

revoke trigger on table "public"."comment" from "service_role";

revoke truncate on table "public"."comment" from "service_role";

revoke update on table "public"."comment" from "service_role";

revoke delete on table "public"."comment_vote" from "anon";

revoke insert on table "public"."comment_vote" from "anon";

revoke references on table "public"."comment_vote" from "anon";

revoke select on table "public"."comment_vote" from "anon";

revoke trigger on table "public"."comment_vote" from "anon";

revoke truncate on table "public"."comment_vote" from "anon";

revoke update on table "public"."comment_vote" from "anon";

revoke delete on table "public"."comment_vote" from "authenticated";

revoke insert on table "public"."comment_vote" from "authenticated";

revoke references on table "public"."comment_vote" from "authenticated";

revoke select on table "public"."comment_vote" from "authenticated";

revoke trigger on table "public"."comment_vote" from "authenticated";

revoke truncate on table "public"."comment_vote" from "authenticated";

revoke update on table "public"."comment_vote" from "authenticated";

revoke delete on table "public"."comment_vote" from "service_role";

revoke insert on table "public"."comment_vote" from "service_role";

revoke references on table "public"."comment_vote" from "service_role";

revoke select on table "public"."comment_vote" from "service_role";

revoke trigger on table "public"."comment_vote" from "service_role";

revoke truncate on table "public"."comment_vote" from "service_role";

revoke update on table "public"."comment_vote" from "service_role";

revoke delete on table "public"."draft" from "anon";

revoke insert on table "public"."draft" from "anon";

revoke references on table "public"."draft" from "anon";

revoke select on table "public"."draft" from "anon";

revoke trigger on table "public"."draft" from "anon";

revoke truncate on table "public"."draft" from "anon";

revoke update on table "public"."draft" from "anon";

revoke delete on table "public"."draft" from "authenticated";

revoke insert on table "public"."draft" from "authenticated";

revoke references on table "public"."draft" from "authenticated";

revoke select on table "public"."draft" from "authenticated";

revoke trigger on table "public"."draft" from "authenticated";

revoke truncate on table "public"."draft" from "authenticated";

revoke update on table "public"."draft" from "authenticated";

revoke delete on table "public"."draft" from "service_role";

revoke insert on table "public"."draft" from "service_role";

revoke references on table "public"."draft" from "service_role";

revoke select on table "public"."draft" from "service_role";

revoke trigger on table "public"."draft" from "service_role";

revoke truncate on table "public"."draft" from "service_role";

revoke update on table "public"."draft" from "service_role";

revoke delete on table "public"."follow" from "anon";

revoke insert on table "public"."follow" from "anon";

revoke references on table "public"."follow" from "anon";

revoke select on table "public"."follow" from "anon";

revoke trigger on table "public"."follow" from "anon";

revoke truncate on table "public"."follow" from "anon";

revoke update on table "public"."follow" from "anon";

revoke delete on table "public"."follow" from "authenticated";

revoke insert on table "public"."follow" from "authenticated";

revoke references on table "public"."follow" from "authenticated";

revoke select on table "public"."follow" from "authenticated";

revoke trigger on table "public"."follow" from "authenticated";

revoke truncate on table "public"."follow" from "authenticated";

revoke update on table "public"."follow" from "authenticated";

revoke delete on table "public"."follow" from "service_role";

revoke insert on table "public"."follow" from "service_role";

revoke references on table "public"."follow" from "service_role";

revoke select on table "public"."follow" from "service_role";

revoke trigger on table "public"."follow" from "service_role";

revoke truncate on table "public"."follow" from "service_role";

revoke update on table "public"."follow" from "service_role";

revoke delete on table "public"."profile" from "anon";

revoke insert on table "public"."profile" from "anon";

revoke references on table "public"."profile" from "anon";

revoke select on table "public"."profile" from "anon";

revoke trigger on table "public"."profile" from "anon";

revoke truncate on table "public"."profile" from "anon";

revoke update on table "public"."profile" from "anon";

revoke delete on table "public"."profile" from "authenticated";

revoke insert on table "public"."profile" from "authenticated";

revoke references on table "public"."profile" from "authenticated";

revoke select on table "public"."profile" from "authenticated";

revoke trigger on table "public"."profile" from "authenticated";

revoke truncate on table "public"."profile" from "authenticated";

revoke update on table "public"."profile" from "authenticated";

revoke delete on table "public"."profile" from "service_role";

revoke insert on table "public"."profile" from "service_role";

revoke references on table "public"."profile" from "service_role";

revoke select on table "public"."profile" from "service_role";

revoke trigger on table "public"."profile" from "service_role";

revoke truncate on table "public"."profile" from "service_role";

revoke update on table "public"."profile" from "service_role";

revoke insert on table "public"."profile" from "supabase_auth_admin";

revoke delete on table "public"."statement" from "anon";

revoke insert on table "public"."statement" from "anon";

revoke references on table "public"."statement" from "anon";

revoke select on table "public"."statement" from "anon";

revoke trigger on table "public"."statement" from "anon";

revoke truncate on table "public"."statement" from "anon";

revoke update on table "public"."statement" from "anon";

revoke delete on table "public"."statement" from "authenticated";

revoke insert on table "public"."statement" from "authenticated";

revoke references on table "public"."statement" from "authenticated";

revoke select on table "public"."statement" from "authenticated";

revoke trigger on table "public"."statement" from "authenticated";

revoke truncate on table "public"."statement" from "authenticated";

revoke update on table "public"."statement" from "authenticated";

revoke delete on table "public"."statement" from "service_role";

revoke insert on table "public"."statement" from "service_role";

revoke references on table "public"."statement" from "service_role";

revoke select on table "public"."statement" from "service_role";

revoke trigger on table "public"."statement" from "service_role";

revoke truncate on table "public"."statement" from "service_role";

revoke update on table "public"."statement" from "service_role";

revoke delete on table "public"."statement_citation" from "anon";

revoke insert on table "public"."statement_citation" from "anon";

revoke references on table "public"."statement_citation" from "anon";

revoke select on table "public"."statement_citation" from "anon";

revoke trigger on table "public"."statement_citation" from "anon";

revoke truncate on table "public"."statement_citation" from "anon";

revoke update on table "public"."statement_citation" from "anon";

revoke delete on table "public"."statement_citation" from "authenticated";

revoke insert on table "public"."statement_citation" from "authenticated";

revoke references on table "public"."statement_citation" from "authenticated";

revoke select on table "public"."statement_citation" from "authenticated";

revoke trigger on table "public"."statement_citation" from "authenticated";

revoke truncate on table "public"."statement_citation" from "authenticated";

revoke update on table "public"."statement_citation" from "authenticated";

revoke delete on table "public"."statement_citation" from "service_role";

revoke insert on table "public"."statement_citation" from "service_role";

revoke references on table "public"."statement_citation" from "service_role";

revoke select on table "public"."statement_citation" from "service_role";

revoke trigger on table "public"."statement_citation" from "service_role";

revoke truncate on table "public"."statement_citation" from "service_role";

revoke update on table "public"."statement_citation" from "service_role";

revoke delete on table "public"."statement_image" from "anon";

revoke insert on table "public"."statement_image" from "anon";

revoke references on table "public"."statement_image" from "anon";

revoke select on table "public"."statement_image" from "anon";

revoke trigger on table "public"."statement_image" from "anon";

revoke truncate on table "public"."statement_image" from "anon";

revoke update on table "public"."statement_image" from "anon";

revoke delete on table "public"."statement_image" from "authenticated";

revoke insert on table "public"."statement_image" from "authenticated";

revoke references on table "public"."statement_image" from "authenticated";

revoke select on table "public"."statement_image" from "authenticated";

revoke trigger on table "public"."statement_image" from "authenticated";

revoke truncate on table "public"."statement_image" from "authenticated";

revoke update on table "public"."statement_image" from "authenticated";

revoke delete on table "public"."statement_image" from "service_role";

revoke insert on table "public"."statement_image" from "service_role";

revoke references on table "public"."statement_image" from "service_role";

revoke select on table "public"."statement_image" from "service_role";

revoke trigger on table "public"."statement_image" from "service_role";

revoke truncate on table "public"."statement_image" from "service_role";

revoke update on table "public"."statement_image" from "service_role";

revoke delete on table "public"."statement_vote" from "anon";

revoke insert on table "public"."statement_vote" from "anon";

revoke references on table "public"."statement_vote" from "anon";

revoke select on table "public"."statement_vote" from "anon";

revoke trigger on table "public"."statement_vote" from "anon";

revoke truncate on table "public"."statement_vote" from "anon";

revoke update on table "public"."statement_vote" from "anon";

revoke delete on table "public"."statement_vote" from "authenticated";

revoke insert on table "public"."statement_vote" from "authenticated";

revoke references on table "public"."statement_vote" from "authenticated";

revoke select on table "public"."statement_vote" from "authenticated";

revoke trigger on table "public"."statement_vote" from "authenticated";

revoke truncate on table "public"."statement_vote" from "authenticated";

revoke update on table "public"."statement_vote" from "authenticated";

revoke delete on table "public"."statement_vote" from "service_role";

revoke insert on table "public"."statement_vote" from "service_role";

revoke references on table "public"."statement_vote" from "service_role";

revoke select on table "public"."statement_vote" from "service_role";

revoke trigger on table "public"."statement_vote" from "service_role";

revoke truncate on table "public"."statement_vote" from "service_role";

revoke update on table "public"."statement_vote" from "service_role";

revoke delete on table "public"."subscription" from "anon";

revoke insert on table "public"."subscription" from "anon";

revoke references on table "public"."subscription" from "anon";

revoke select on table "public"."subscription" from "anon";

revoke trigger on table "public"."subscription" from "anon";

revoke truncate on table "public"."subscription" from "anon";

revoke update on table "public"."subscription" from "anon";

revoke delete on table "public"."subscription" from "authenticated";

revoke insert on table "public"."subscription" from "authenticated";

revoke references on table "public"."subscription" from "authenticated";

revoke select on table "public"."subscription" from "authenticated";

revoke trigger on table "public"."subscription" from "authenticated";

revoke truncate on table "public"."subscription" from "authenticated";

revoke update on table "public"."subscription" from "authenticated";

revoke delete on table "public"."subscription" from "service_role";

revoke insert on table "public"."subscription" from "service_role";

revoke references on table "public"."subscription" from "service_role";

revoke select on table "public"."subscription" from "service_role";

revoke trigger on table "public"."subscription" from "service_role";

revoke truncate on table "public"."subscription" from "service_role";

revoke update on table "public"."subscription" from "service_role";

create table "public"."notification_policy" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "handle" text not null,
    "medium" text not null,
    "recipient_id" uuid not null,
    "object_id" text not null,
    "paused" boolean not null default false
);


alter table "public"."notification_policy" enable row level security;

alter table "public"."profile" alter column "email" set not null;

alter table "public"."subscription" alter column "email" drop default;

CREATE UNIQUE INDEX notification_policy_pkey ON public.notification_policy USING btree (id);

alter table "public"."notification_policy" add constraint "notification_policy_pkey" PRIMARY KEY using index "notification_policy_pkey";

alter table "public"."notification_policy" add constraint "notification_policy_recipient_id_fkey" FOREIGN KEY (recipient_id) REFERENCES profile(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."notification_policy" validate constraint "notification_policy_recipient_id_fkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.handle_upsert_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_username text;
  v_email    text;
  v_picture  text;
  v_name     text;
BEGIN
  -- Extract metadata
  v_username := (NEW.raw_user_meta_data::jsonb)->>'username';
  v_email    := COALESCE((NEW.raw_user_meta_data::jsonb)->>'email', NEW.email);
  v_picture  := (NEW.raw_user_meta_data::jsonb)->>'picture';

  v_name := COALESCE(
    NULLIF((NEW.raw_user_meta_data::jsonb)->>'name',''),
    NULLIF((NEW.raw_user_meta_data::jsonb)->>'full_name',''),
    NULLIF(
      trim(
        COALESCE((NEW.raw_user_meta_data::jsonb)->>'given_name','') || ' ' ||
        COALESCE((NEW.raw_user_meta_data::jsonb)->>'family_name','')
      ), ''
    )
  );

  -- Fallback username if missing
  IF v_username IS NULL OR v_username = '' THEN
    v_username := COALESCE(split_part(v_email, '@', 1), 'user') || '-' ||
                  substring(NEW.id::text from 1 for 6);
  END IF;

  INSERT INTO public.profile (id, username, image_url, email, name)
  VALUES (NEW.id, v_username, v_picture, v_email, v_name)
  ON CONFLICT (id) DO UPDATE
    SET username = COALESCE(EXCLUDED.username, profile.username),
        image_url = COALESCE(EXCLUDED.image_url, profile.image_url),
        email     = COALESCE(EXCLUDED.email, profile.email),
        name      = COALESCE(EXCLUDED.name, profile.name);

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  SET search_path TO public;
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;

create policy "Allow postgres insert"
on "public"."profile"
as permissive
for insert
to postgres
with check (true);


create policy "Allow postgres update"
on "public"."profile"
as permissive
for update
to postgres
using (true);


create policy "Allow service_role insert"
on "public"."profile"
as permissive
for insert
to service_role
with check (true);


create policy "Allow service_role update"
on "public"."profile"
as permissive
for update
to service_role
using (true);




